# Lab 1: Booting a PC

## 1.1 简介

- 实验分成三部分
  - 第一部分的重心在于熟悉x86汇编语言，QEMU，和给PC加电时引导程序的步骤
  - 第二部分查看了6.828内核的引导加载程序，它位于实验的boot目录下
  - 第三部分研究了6.828内核本身的初始化模板，它的名字叫JOS，位于kernel目录下

### 1.1.1 启动软件

- ###

### 1.1.2 提交步骤

- ###

## 1.2 第一部分：PC引导过程

- Exercise 1介绍x86汇编语言和PC引导过程，需要QEMU和QEMU / GDB调试
  - 不用写代码

### 1.2.1 x86汇编入门

- 资料：PC Assembly Language Book

- ###

### 1.2.2 模拟x86

- 不在真实的PC上开发操作系统，而是在一个能模拟PC的程序上进行开发
  - 使用QEMU仿真器
  - QEMU可以充当GDB的远程调试目标
- 把Lab 1文件解压到一个目录，然后make，构建将要启动的引导加载程序和内核
  - 会在以后的实验中逐渐充实这个内核
- 命令行和QEMU界面可以等价
- 目前只有两个命令：help和kerninfo
  - help命令的效果很显然，输出目前能使用的命令
  - kerninfo命令打印的内容
    - 将obj / kern / kernel.img的内容复制到真实硬盘的前几个扇区中，将该硬盘插入真实PC中，打开它，然后在上面看到完全相同的内容
    - 不建议这么做，会破坏原来真实PC的扇区

### 1.2.3 PC的物理地址空间

- 接下来，详细介绍PC的启动方式

- PC物理地址空间是硬连线的，具有以下常规布局（见图）

  - 第一台PC，处理器是16位的，它只能处理1MB的物理内存
    - 16位原本只能处理256KB的物理内存，后来引入了一种选择机制（见《深入理解Linux内核》）
    - Low Memory那部分是给RAM用的
    - 硬件保留了从0x000A0000到0x000FFFFF的384KB区域，用于特殊用途，例如视频显示缓冲区和非易失性存储器中保存的固件
      - 此保留区中最重要的部分是基本输入/输出系统（BIOS），它占用从0x000F0000到0x000FFFFF的64KB区域
      - 在早期的PC中，BIOS被保存在真正的ROM中
      - 当前的PC将BIOS存储在可更新的闪存中
      - BIOS负责执行基本的系统初始化，例如激活视频卡和检查已安装的内存量。执行此初始化之后，BIOS从某个适当的位置（例如软盘，硬盘，CD-ROM或网络）加载操作系统，并将计算机的控制权传递给操作系统
  - 80286和80386分别支持16MB和4GB物理地址空间，打破了1MB字节的限制
    - 依然位低1MB的物理地址空间保留了原始布局，以便向后兼容现有软件
    - 因此，现代PC在从0x000A0000到0x00100000的物理内存中有个“空洞”，将RAM分为常规内存（前640KB）和扩展内存（其余部分）

  - 最新的x86处理器可以支持超过4GB的物理RAM
    - ###

### 1.2.4 The ROM BOIS

- 本部分的实验，将使用QEMU的调试工具，来研究IA-32兼容计算机的启动方式

- 输出中有一行

  ```bash
  [f000：fff0] 0xffff0: ljmp $0xf000, $0xe05b
  ```

  从输出中可以获得以下结论

  - 第一条指令执行前，PC的值是0xffff0
    - 该地址位于ROM BIOS保留的64KB区域的最顶部
  - 中括号内的是分段地址CS: IP，它们是如何转换成物理地址的
    - PC启动的时候采用实模式寻址的方式，地址转换根据以下公式工作：物理地址 = 16 *段 + 偏移量
    - 在这个例子中，0xf000 * 16 = 0xf0000，再加上0xfff0，得到物理地址0xffff0
    - 为了实现向后兼容性，即原来运行在8088处理器上的软件仍旧能在现代处理器上运行，所以现代的CPU都是在启动时运行于实模式，启动完成后运行于保护模式
      - BIOS就是PC刚启动时运行的软件，所以它必然工作在实模式
  - 要执行的第一条指令是jmp指令，跳转到分段地址0xfe05b
    - 这是很合理的，因为之前的地址离BIOS的末尾已经只有16个字节了，需要跳到早一点的地址，才能正常执行若干指令

- BIOS运行时，它将建立一个中断描述符表并初始化各种设备，例如VGA显示。
  - QEMU窗口中看到的“正在启动SeaBIOS”消息的来源

- 初始化PCI总线和BIOS知道的所有重要设备后，它将搜索可引导设备，例如软盘，硬盘驱动器或CD-ROM
  - 最终，BIOS在找到可引导磁盘时，会从磁盘读取引导加载程序，并将控制权转移给该引导加载程序


# 5 文件系统

## 5.1 文件系统的相关概念和基础

- 比真实的文件系统更简化，提供以下基本功能
  - 创建
  - 读取
  - 写入
  - 删除
- 不支持多线程
  - 没有文件所有权和权限的概念
  - 不支持硬链接、符号链接、时间戳或特殊文件设备

### 5.1.1 相关的数据结构

- 文件系统把磁盘空间划分为两部分， inode 区域和数据区域
  - JOS 没有 inode

### 5.1.2 扇区和块

- JOS 中，扇区大小为 512 字节，而块大小为 4096 字节
  - 扇区是硬件的属性，块是操作系统如何使用磁盘的属性

### 5.1.3 超级块

- 超级块描述整个文件系统的元信息，如
  - 块大小
  - 磁盘大小
  - 根目录相关的元数据
  - 文件系统上次挂载的事件
  - 文件系统上次检查错误的事件
  - ...
- JOS 的超级块位于磁盘块 1
  - 块 0 通常用于保存 bootloader 程序和分区表
  - 超级块的定义见 `inc.fs.h` 的 `struct Super` 

### 5.1.4 文件元数据

- 定义在 `inc/fs.h` 中的 `struct File` 包括了
  - 文件名称
  - 大小
  - 类型（文件或目录）
  - 指向组成文件的块的指针
- `struct File` 的 `f_direct` 数组包含存储文件的前 10 个块号，也就是直接块
  - 对于大文件，会有间接块，间接块存放块号

### 5.1.5 目录和常规文件

- `struct File` 可以表示一个普通文件或目录
  - 通过 `type` 字段来区分
- 超级块中包含一个 `File` 结构，是 `Super` 结构中的 `root` 字段
  - 这个 `File` 结构保存根目录的元数据

## 5.2 文件系统

- 本实验只需要实现文件系统的某些关键组件
  - 读入块缓存，并刷新回磁盘
  - 分配磁盘块
  - 根据文件偏移量找到对应的磁盘块
  - 在 IPC 接口中实现读、写和打开

### 5.2.1 磁盘访问

- 文件系统环境需要有访问磁盘的权限
  - 按照微内核的思想，内核会实现磁盘访问功能，即向内核添加 IDE 磁盘驱动程序以及必要的文件系统调用，以允许文件系统访问它
  - JOS 内核没有提供磁盘访问，而是将 IDE 磁盘驱动程序实现为用户级环境的一部分
  - 微内核、宏内核？？？
- 文件系统有独立于其他环境的虚拟地址空间，称作 I/O 空间
  - 文件系统环境需要访问 I/O 空间，而别的环境不应该有这个权限，因此环境需要一个权限位，JOS 中是 EFLAGS 寄存器的  `IOPL` 位
- Code: 修改 `env.c` 的 `env_create()` ，以确保可以启动文件系统环境
  - 需要通过 `make grade` 的 `fs i/o` 测试

### 5.2.2 块缓存

- 块缓存就是磁盘块在内存中的缓存

- Code: 实现 `fs/bc.c` 的 `bc_pgfault()` 和 `flush_block()` 
  - `bc_pgfault()` 是一个页错误处理程序，和 lab 4 中为写时复制的 `fork()` 编写的错误处理程序类似，只不过这次是从磁盘加载页面来响应页错误
    - `addr` 可能未块对齐
    - `ide_read()` 在扇区中而不是块中操作
  - `flush_block()` 把块写入磁盘
    - 如果块不在块缓存中（即这个块没有被映射到某个虚拟地址上），或者不是脏块，就不用做任何事情
    - 查看 `uvpt` 的元素中，是否设置了 `PTE_D` 位
    - 将块写入磁盘后， 通过 `sys_page_map()` 清除 `PTE_D` 位
  - 需要通过 `make grade` 的 `check_bc` , `check_super` 和 `check_bitmap` 

### 5.2.3 位图

- Code: 实现 `fs/fs.c` 的 `alloc_block` 
  - 在位图中找到空闲块，标记为已使用，返回块号
  - 分配时，应立即使用 `flush_block` 将更改后的位图块刷新到磁盘

### 5.2.4 和文件相关的操作

-  `fs/fs.c` 中提供了一些函数，它们实现了
  - 解析和管理 `File` 结构体
  - 扫描和管理目录项
  - 从根目录遍历文件系统，以解析文件的绝对路径
- Code: 实现 `file_block_walk()` 和 `file_get_block()` 
  - `file_block_walk()`  
  - `file_get_block()` 
  - 需要通过 `make grade` 的 `file_open` , `file_get_block` , `file_flush/file_truncated/filewrite` 和 `testfile`  

### 5.2.5 文件系统相关的接口





- 文件系统环境
  - 用户级
- 文件系统有独立于其他环境的虚拟地址空间
- 块和扇区的区别

